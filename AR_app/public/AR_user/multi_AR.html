<!DOCTYPE html>
<html lang="ja">
  <head>
    <link rel="stylesheet" href="static/user.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.3.0/jsQR.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR</title>
  </head>

  <body style="margin: 0px; overflow: hidden;">
    <div id="marker-images-container" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px;">
      <!-- マーカー画像がここに動的に追加されます -->
    </div>

    <div id="subtitle">ここに字幕が表示されます</div>
    <button id="toggle-volume" class="top-right-button" style="right: 200px;">音量ON</button>
    <button id="toggle-subtitle" class="top-right-button" style="right: 320px;">字幕OFF</button>
    <a href="home.html"><button class="top-right-button">戻る</button></a>

    <canvas id="qr-canvas" style="display:none;"></canvas>

    <script>
      const subtitle = document.querySelector('#subtitle');
      const toggleVolumeButton = document.querySelector('#toggle-volume');
      const toggleSubtitleButton = document.querySelector('#toggle-subtitle');
      
      let subtitles = [];
      let currentSubtitleIndex = 0;
      let subtitleTimeout;
      let subtitlesVisible = false;
      let audioMuted = false;
      
      // 音量切替
      toggleVolumeButton.addEventListener('click', function () {
        audioMuted = !audioMuted;
        if (audioMuted) {
          audio.muted = true;
          toggleVolumeButton.textContent = '音量OFF';
        } else {
          audio.muted = false;
          toggleVolumeButton.textContent = '音量ON';
        }
      });

      // サーバーからマルチARデータを取得
      fetch('/api/multiAR')
        .then(response => response.json())
        .then(models => {
          const markerImagesContainer = document.querySelector('#marker-images-container');

          models.forEach(model => {
            // マーカー画像を追加
            markerImagesContainer.innerHTML += `
              <div style="border: 1px solid #ccc; padding: 10px;">
                <h3>マーカー: ${model.patt}</h3>
                <img src="/Content/${model.mkimage}" alt="Marker Image" style="width: 150px; height: 150px; object-fit: cover;">
              </div>
            `;
          });
        })
        .catch(error => console.error('Error fetching multiAR data:', error));

      // サブタイトルの表示
      function loadSubtitles() {
        return fetch('zimaku.txt')
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.text();
          })
          .then(text => {
            subtitles = text.split('\n');
          })
          .catch(error => console.error('Error fetching subtitles:', error));
      }

      function showSubtitle() {
        if (subtitlesVisible && currentSubtitleIndex < subtitles.length) {
          subtitle.textContent = subtitles[currentSubtitleIndex];
          subtitle.style.display = 'block';
          currentSubtitleIndex++;

          subtitleTimeout = setTimeout(() => {
            subtitle.style.display = 'none';
            showSubtitle();
          }, 2000);
        }
      }

      toggleSubtitleButton.addEventListener('click', function () {
        subtitlesVisible = !subtitlesVisible;
        if (subtitlesVisible) {
          toggleSubtitleButton.textContent = '字幕ON';
          showSubtitle();
        } else {
          toggleSubtitleButton.textContent = '字幕OFF';
          subtitle.style.display = 'none';
          clearTimeout(subtitleTimeout);
        }
      });
    </script>
  </body>
</html>
