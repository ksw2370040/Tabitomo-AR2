<!DOCTYPE html>
<html lang="ja">
  <head>
    <link rel="stylesheet" href="static/user.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dモデル一覧</title>
  </head>

  <body>
    <h1>3Dモデル一覧</h1>

    <div id="model-list">
      <!-- モデル一覧が動的に追加される場所 -->
    </div>

    <div id="subtitle">ここに字幕が表示されます</div>
    <button id="toggle-volume" class="top-right-button" style="right: 200px;">音量ON</button>
    <button id="toggle-subtitle" class="top-right-button" style="right: 320px;">字幕OFF</button>
    <a href="home.html"><button class="top-right-button">戻る</button></a>

    <script>
      const subtitle = document.querySelector('#subtitle');
      const toggleVolumeButton = document.querySelector('#toggle-volume');
      const toggleSubtitleButton = document.querySelector('#toggle-subtitle');
      
      let subtitles = [];
      let currentSubtitleIndex = 0;
      let subtitleTimeout;
      let subtitlesVisible = false;
      let audioMuted = false;

      // 音量切替
      toggleVolumeButton.addEventListener('click', function () {
        audioMuted = !audioMuted;
        if (audioMuted) {
          audio.muted = true;
          toggleVolumeButton.textContent = '音量OFF';
        } else {
          audio.muted = false;
          toggleVolumeButton.textContent = '音量ON';
        }
      });

      // サーバーから3Dモデルデータを取得
      fetch('/api/multiAR')
        .then(response => response.json())
        .then(models => {
          const modelListContainer = document.querySelector('#model-list');

          models.forEach(model => {
            // モデルアイテムを一覧表示
            modelListContainer.innerHTML += `
              <div class="model-item">
                <h3>モデル: ${model.mdlimage}</h3>
                <a-entity scale="1 1 1">
                  <!-- 修正: パスを適切に設定 -->
                  <a-asset-item id="model-${model.mdlimage}" src="/Content/.glb/${model.mdlimage}"></a-asset-item>
                  <a-entity gltf-model="#model-${model.mdlimage}" scale="0.5 0.5 0.5"></a-entity>
                </a-entity>
                <!-- 音声再生ボタン -->
                <audio id="audio-${model.mdlimage}" src="/Content/sound/${model.soundfile}" preload="auto"></audio>
                <button onclick="playAudio('${model.mdlimage}')">音声再生</button>
              </div>
            `;
          });
        })
        .catch(error => console.error('Error fetching models data:', error));

      // 音声再生
      function playAudio(modelId) {
        const audioElement = document.querySelector(`#audio-${modelId}`);
        if (audioElement) {
          audioElement.play();
        }
      }

      // サブタイトルの表示
      function loadSubtitles() {
        return fetch('zimaku.txt')
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.text();
          })
          .then(text => {
            subtitles = text.split('\n');
          })
          .catch(error => console.error('Error fetching subtitles:', error));
      }

      function showSubtitle() {
        if (subtitlesVisible && currentSubtitleIndex < subtitles.length) {
          subtitle.textContent = subtitles[currentSubtitleIndex];
          subtitle.style.display = 'block';
          currentSubtitleIndex++;

          subtitleTimeout = setTimeout(() => {
            subtitle.style.display = 'none';
            showSubtitle();
          }, 2000);
        }
      }

      toggleSubtitleButton.addEventListener('click', function () {
        subtitlesVisible = !subtitlesVisible;
        if (subtitlesVisible) {
          toggleSubtitleButton.textContent = '字幕ON';
          showSubtitle();
        } else {
          toggleSubtitleButton.textContent = '字幕OFF';
          subtitle.style.display = 'none';
          clearTimeout(subtitleTimeout);
        }
      });
    </script>
  </body>
</html>
