<!DOCTYPE html>
<html lang="ja">
  <head>
    <link rel="stylesheet" href="static/user.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dモデル一覧</title>
  </head>

  <body>
    <h1>3Dモデル一覧</h1>

    <div id="model-list">
      <!-- モデル一覧が動的に追加される場所 -->
    </div>

    <div id="selected-model">
      <!-- 選択したモデルが表示される場所 -->
      <h2>選択したモデル</h2>
      <a-scene embedded>
        <a-entity id="model-display" position="0 0 0"></a-entity>
        <a-camera></a-camera>
      </a-scene>
    </div>

    <div id="subtitle">ここに字幕が表示されます</div>
    <button id="toggle-volume" class="top-right-button" style="right: 200px;">音量ON</button>
    <button id="toggle-subtitle" class="top-right-button" style="right: 320px;">字幕OFF</button>
    <a href="home.html"><button class="top-right-button">戻る</button></a>

    <script>
      const subtitle = document.querySelector('#subtitle');
      const toggleVolumeButton = document.querySelector('#toggle-volume');
      const toggleSubtitleButton = document.querySelector('#toggle-subtitle');
      
      let subtitles = [];
      let currentSubtitleIndex = 0;
      let subtitleTimeout;
      let subtitlesVisible = false;
      let audioMuted = false;

      // 音量切替
      toggleVolumeButton.addEventListener('click', function () {
        audioMuted = !audioMuted;
        if (audioMuted) {
          audio.muted = true;
          toggleVolumeButton.textContent = '音量OFF';
        } else {
          audio.muted = false;
          toggleVolumeButton.textContent = '音量ON';
        }
      });

      // サーバーから3Dモデルデータを取得
      fetch('/api/multiAR')
        .then(response => response.json())
        .then(models => {
          const modelListContainer = document.querySelector('#model-list');
          const modelDisplay = document.querySelector('#model-display');

          models.forEach(model => {
            // モデルアイテムを一覧表示
            modelListContainer.innerHTML += `
              <div class="model-item">
                <h3>モデル: ${model.mdlimage}</h3>
                <button onclick="displayModel('${model.mdlimage}')">モデルを表示</button>
              </div>
            `;
          });

          // モデルを選択した場合に表示
          window.displayModel = function(modelId) {
            const modelEntity = document.createElement('a-entity');
            modelEntity.setAttribute('gltf-model', `/Content/.glb/${modelId}`);
            modelEntity.setAttribute('scale', '1 1 1');
            modelEntity.setAttribute('position', '0 0 0');
            modelEntity.setAttribute('rotation', '0 0 0');
            
            // 既存のモデルを削除し新しいモデルを表示
            modelDisplay.innerHTML = ''; 
            modelDisplay.appendChild(modelEntity);
          }
        })
        .catch(error => console.error('Error fetching models data:', error));

      // サブタイトルの表示
      function loadSubtitles() {
        return fetch('zimaku.txt')
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.text();
          })
          .then(text => {
            subtitles = text.split('\n');
          })
          .catch(error => console.error('Error fetching subtitles:', error));
      }

      function showSubtitle() {
        if (subtitlesVisible && currentSubtitleIndex < subtitles.length) {
          subtitle.textContent = subtitles[currentSubtitleIndex];
          subtitle.style.display = 'block';
          currentSubtitleIndex++;

          subtitleTimeout = setTimeout(() => {
            subtitle.style.display = 'none';
            showSubtitle();
          }, 2000);
        }
      }

      toggleSubtitleButton.addEventListener('click', function () {
        subtitlesVisible = !subtitlesVisible;
        if (subtitlesVisible) {
          toggleSubtitleButton.textContent = '字幕ON';
          showSubtitle();
        } else {
          toggleSubtitleButton.textContent = '字幕OFF';
          subtitle.style.display = 'none';
          clearTimeout(subtitleTimeout);
        }
      });
    </script>
  </body>
</html>
