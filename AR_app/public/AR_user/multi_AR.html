<!DOCTYPE html>
<html lang="ja">
  <!-- C:\Tabitomo-AR\AR_app\public\AR_user\test2.html -->
<head>
  <link rel="stylesheet" href="static/user.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.3.0/jsQR.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebAR</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://ar-js-org.github.io/AR.js/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin: 0px; overflow: hidden;">
  <a-scene vr-mode-ui="enabled: false;" loading-screen="enabled: false;" renderer="logarithmicDepthBuffer: true;"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;" id="scene" embedded gesture-detector>
    <a-assets>
      <a-asset-item id="animated-asset" src="../Content/.glb/hiyoko5-1737683749786.glb"></a-asset-item>
      <audio id="audio" src="tanktop.mp3" preload="auto"></audio>
      <a-asset-item id="animated-asset2" src="../Content/.glb/free_ac_unit-1737683705900.glb"></a-asset-item>
      <audio id="audio2" src="tanktop.mp3" preload="auto"></audio>
    </a-assets>

    <a-marker id="animated-marker" type="pattern" preset="custom" url="../Content/.patt/pattern-hiyoco-1737683750057.patt"
      raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
      <a-entity id="model" scale="1 1 1" animation-mixer="loop: repeat" gltf-model="#animated-asset" class="clickable"
        animation="property: rotation; to: 0 360 0; dur: 3600; easing: linear; loop: true" gesture-handler
        visible="false"></a-entity>
    </a-marker>

    <a-marker id="animated-marker2" type="pattern" preset="custom" url="../Content/.patt/pattern-marker-1737683711197.patt"
      raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
      <a-entity id="model2" scale="1 1 1" animation-mixer="loop: repeat" gltf-model="#animated-asset2" class="clickable"
        animation="property: rotation; to: 0 360 0; dur: 3600; easing: linear; loop: true" gesture-handler
        visible="false"></a-entity>
    </a-marker>

    <a-entity camera position="0 0 10"></a-entity>
  </a-scene>

  <div id="subtitle">ここに字幕が表示されます</div>

  <button id="toggle-volume" class="top-right-button" style="right: 200px;">音量ON</button>
  <button id="toggle-subtitle" class="top-right-button" style="right: 320px;">字幕OFF</button>
  <a href="home.html"><button class="top-right-button">戻る</button></a>

  <canvas id="qr-canvas" style="display:none;"></canvas>

  <script>
    const marker1 = document.querySelector('#animated-marker');
    const model1 = document.querySelector('#model');
    const audio1 = document.querySelector('#audio');

    const marker2 = document.querySelector('#animated-marker2');
    const model2 = document.querySelector('#model2');
    const audio2 = document.querySelector('#audio2');

    const subtitle = document.querySelector('#subtitle');
    const toggleVolumeButton = document.querySelector('#toggle-volume');
    const toggleSubtitleButton = document.querySelector('#toggle-subtitle');

    let subtitles = [];
    let currentSubtitleIndex = 0;
    const displayDuration = 2000;
    let subtitleTimeout;
    let subtitlesVisible = false;
    let audioMuted = false;

    toggleVolumeButton.addEventListener('click', function () {
      audioMuted = !audioMuted;

      if (audioMuted) {
        audio1.muted = true;
        audio2.muted = true;
        toggleVolumeButton.textContent = '音量OFF';
      } else {
        audio1.muted = false;
        audio2.muted = false;
        toggleVolumeButton.textContent = '音量ON';
      }
    });

    function loadSubtitles() {
      return fetch('zimaku.txt')
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.text();
        })
        .then(text => {
          subtitles = text.split('\n');
        })
        .catch(error => console.error('Error fetching subtitles:', error));
    }

    function showSubtitle() {
      if (subtitlesVisible && currentSubtitleIndex < subtitles.length) {
        subtitle.textContent = subtitles[currentSubtitleIndex];
        subtitle.style.display = 'block';
        currentSubtitleIndex++;

        subtitleTimeout = setTimeout(() => {
          subtitle.style.display = 'none';
          showSubtitle();
        }, displayDuration);
      }
    }

    function handleMarkerEvents(marker, model, audio) {
      marker.addEventListener('markerFound', function () {
        model.setAttribute('visible', true);
        audio.play();
        loadSubtitles().then(() => {
          showSubtitle();
        });
      });

      marker.addEventListener('markerLost', function () {
        model.setAttribute('visible', false);
        audio.pause();
        audio.currentTime = 0;
        subtitle.style.display = 'none';
        currentSubtitleIndex = 0;
        clearTimeout(subtitleTimeout);
      });
    }

    toggleSubtitleButton.addEventListener('click', function () {
      subtitlesVisible = !subtitlesVisible;

      if (subtitlesVisible) {
        toggleSubtitleButton.textContent = '字幕ON';
        showSubtitle();
      } else {
        toggleSubtitleButton.textContent = '字幕OFF';
        subtitle.style.display = 'none';
        clearTimeout(subtitleTimeout);
      }
    });

    handleMarkerEvents(marker1, model1, audio1);
    handleMarkerEvents(marker2, model2, audio2);

  </script>
</body>

</html>
