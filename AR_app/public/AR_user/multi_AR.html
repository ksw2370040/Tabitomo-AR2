<!DOCTYPE html>
<html lang="ja">
  <head>
    <link rel="stylesheet" href="static/user.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.3.0/jsQR.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://ar-js-org.github.io/AR.js/aframe/build/aframe-ar.js"></script>
  </head>

  <body style="margin: 0px; overflow: hidden;">
    <a-scene vr-mode-ui="enabled: false;" loading-screen="enabled: false;" renderer="logarithmicDepthBuffer: true;"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;" id="scene" embedded gesture-detector>
      
      <!-- アセットを動的に挿入する -->
      <a-assets id="assets"></a-assets>

      <!-- 動的に生成されるマーカー -->
      <div id="markers-container"></div>

      <a-entity camera position="0 0 10"></a-entity>
    </a-scene>

    <div id="subtitle">ここに字幕が表示されます</div>
    <button id="toggle-volume" class="top-right-button" style="right: 200px;">音量ON</button>
    <button id="toggle-subtitle" class="top-right-button" style="right: 320px;">字幕OFF</button>
    <a href="home.html"><button class="top-right-button">戻る</button></a>

    <canvas id="qr-canvas" style="display:none;"></canvas>

    <script>
      const subtitle = document.querySelector('#subtitle');
      const toggleVolumeButton = document.querySelector('#toggle-volume');
      const toggleSubtitleButton = document.querySelector('#toggle-subtitle');
      
      let subtitles = [];
      let currentSubtitleIndex = 0;
      let subtitleTimeout;
      let subtitlesVisible = false;
      let audioMuted = false;
      
      // 音量切替
      toggleVolumeButton.addEventListener('click', function () {
        audioMuted = !audioMuted;
        if (audioMuted) {
          audio.muted = true;
          toggleVolumeButton.textContent = '音量OFF';
        } else {
          audio.muted = false;
          toggleVolumeButton.textContent = '音量ON';
        }
      });

      // サーバーからマルチARデータを取得
      fetch('/multiAR')
        .then(response => response.json())
        .then(models => {
          const assets = document.querySelector('#assets');
          const markersContainer = document.querySelector('#markers-container');

          models.forEach(model => {
            // アセットアイテムを追加
            assets.innerHTML += `
              <a-asset-item id="model-${model.mdlimage}" src="/Content/${model.mdlimage}"></a-asset-item>
              <audio id="audio-${model.mdlimage}" src="/Content/${model.soundfile}" preload="auto"></audio>
            `;

            // マーカーを追加
            markersContainer.innerHTML += `
              <a-marker id="marker-${model.patt}" type="pattern" preset="custom" url="/Content/${model.patt}">
                <a-entity id="model-${model.patt}" scale="1 1 1" animation-mixer="loop: repeat" 
                          gltf-model="#model-${model.mdlimage}" visible="false"></a-entity>
              </a-marker>
            `;
          });
        })
        .catch(error => console.error('Error fetching multiAR data:', error));

      // サブタイトルの表示
      function loadSubtitles() {
        return fetch('zimaku.txt')
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.text();
          })
          .then(text => {
            subtitles = text.split('\n');
          })
          .catch(error => console.error('Error fetching subtitles:', error));
      }

      function showSubtitle() {
        if (subtitlesVisible && currentSubtitleIndex < subtitles.length) {
          subtitle.textContent = subtitles[currentSubtitleIndex];
          subtitle.style.display = 'block';
          currentSubtitleIndex++;

          subtitleTimeout = setTimeout(() => {
            subtitle.style.display = 'none';
            showSubtitle();
          }, 2000);
        }
      }

      toggleSubtitleButton.addEventListener('click', function () {
        subtitlesVisible = !subtitlesVisible;
        if (subtitlesVisible) {
          toggleSubtitleButton.textContent = '字幕ON';
          showSubtitle();
        } else {
          toggleSubtitleButton.textContent = '字幕OFF';
          subtitle.style.display = 'none';
          clearTimeout(subtitleTimeout);
        }
      });
    </script>
  </body>
</html>
