<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="stylesheet" href="static/user.css">
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebAR</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://ar-js-org.github.io/AR.js/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin: 0px; overflow: hidden;">
  <a-scene vr-mode-ui="enabled: false;" loading-screen="enabled: false;" renderer="logarithmicDepthBuffer: true;"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;" id="scene" embedded gesture-detector>
    <a-assets>
      <!-- 3Dモデルや音声ファイルを動的に読み込むためのプレースホルダ -->
      <!-- 動的に追加されるモデルや音声をここで定義します -->
    </a-assets>

    <!-- マーカーの設定は動的に追加されます -->
    <a-entity camera position="0 0 0"></a-entity>
  </a-scene>

  <div id="subtitle">ここに字幕が表示されます</div>

  <button id="toggle-volume" class="top-right-button" style="right: 200px;">音量ON</button>
  <button id="toggle-subtitle" class="top-right-button" style="right: 320px;">字幕OFF</button>
  <a href="home.html"><button class="top-right-button">戻る</button></a>

  <canvas id="qr-canvas" style="display:none;"></canvas>

  <script>
    const subtitle = document.querySelector('#subtitle');
    const toggleVolumeButton = document.querySelector('#toggle-volume');
    const toggleSubtitleButton = document.querySelector('#toggle-subtitle');

    let subtitles = [];
    let currentSubtitleIndex = 0;
    const displayDuration = 2000;
    let subtitleTimeout;
    let subtitlesVisible = false;
    let audioMuted = false;

    // URLからlanguagenameを取得
    const urlParams = new URLSearchParams(window.location.search);
    const languagename = urlParams.get('languagename'); // URLのクエリパラメータから取得

    if (!languagename) {
      console.error('languagenameが指定されていません');
      alert('languagenameが指定されていません');
      return;
    }

    // 動的にモデルを追加する関数
    function addModelToScene(modelData) {
      const scene = document.querySelector('a-scene');

      // 新しいマーカー要素を作成
      const marker = document.createElement('a-marker');
      marker.setAttribute('type', 'pattern');
      marker.setAttribute('preset', 'custom');
      marker.setAttribute('url', `/Content/${modelData.patt}`);
      marker.setAttribute('raycaster', 'objects: .clickable');
      marker.setAttribute('emitevents', 'true');
      marker.setAttribute('cursor', 'fuse: false; rayOrigin: mouse;');

      // 新しい3Dモデルを作成
      const model = document.createElement('a-entity');
      model.setAttribute('scale', '1 1 1');
      model.setAttribute('animation-mixer', 'loop: repeat');
      model.setAttribute('gltf-model', `#animated-asset-${modelData.mdlid}`);
      model.classList.add('clickable');
      model.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 3600; easing: linear; loop: true');
      model.setAttribute('gesture-handler', 'visible', false);

      // 3Dモデルをマーカーに追加
      marker.appendChild(model);

      // シーンにマーカーを追加
      scene.appendChild(marker);

      // モデルや音声、字幕を設定
      const asset = document.createElement('a-asset-item');
      asset.setAttribute('id', `animated-asset-${modelData.mdlid}`);
      asset.setAttribute('src', `/Content/${modelData.mdlimage}`);
      scene.appendChild(asset);

      const audio = document.createElement('audio');
      audio.setAttribute('id', `audio-${modelData.mdlid}`);
      audio.setAttribute('src', `/Content/${modelData.soundfile}`);
      audio.setAttribute('preload', 'auto');
      scene.appendChild(audio);
    }

    // 言語に基づいてデータを取得
    fetch(`/multiAR?languagename=${languagename}`)
      .then(response => response.json())
      .then(data => {
        if (data && data.length > 0) {
          data.forEach(item => {
            // 3Dモデルやマーカーの設定を動的に追加
            addModelToScene(item);

            // 字幕の設定
            if (item.napisyfile) {
              subtitles.push(item.napisyfile);
            }
          });
        } else {
          console.error('データが見つかりません');
        }
      })
      .catch(error => console.error('データ取得に失敗しました:', error));

    // 音量のトグル
    toggleVolumeButton.addEventListener('click', function () {
      audioMuted = !audioMuted;
      document.querySelectorAll('audio').forEach(audio => audio.muted = audioMuted);
      toggleVolumeButton.textContent = audioMuted ? '音量OFF' : '音量ON';
    });

    // 字幕の表示制御
    function showSubtitle() {
      if (subtitlesVisible && currentSubtitleIndex < subtitles.length) {
        subtitle.textContent = subtitles[currentSubtitleIndex];
        subtitle.style.display = 'block';
        currentSubtitleIndex++;

        subtitleTimeout = setTimeout(() => {
          subtitle.style.display = 'none';
          showSubtitle();
        }, displayDuration);
      }
    }

    toggleSubtitleButton.addEventListener('click', function () {
      subtitlesVisible = !subtitlesVisible;

      if (subtitlesVisible) {
        toggleSubtitleButton.textContent = '字幕ON';
        showSubtitle();
      } else {
        toggleSubtitleButton.textContent = '字幕OFF';
        subtitle.style.display = 'none';
        clearTimeout(subtitleTimeout);
      }
    });
  </script>
</body>
</html>
