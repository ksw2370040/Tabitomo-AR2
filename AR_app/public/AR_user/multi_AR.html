<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR表示</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://ar-js-org.github.io/AR.js/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin: 0px; overflow: hidden;">
    <a-scene vr-mode-ui="enabled: false;" loading-screen="enabled: false;" renderer="logarithmicDepthBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;" id="scene" embedded>
        
        <a-assets>
            <!-- 動的にモデルや音声を追加する -->
        </a-assets>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // URLパラメータからuseridとlanguagenameを取得
        const urlParams = new URLSearchParams(window.location.search);
        const userid = urlParams.get('userid');
        const languagename = urlParams.get('languagename');

        if (!languagename) {
            alert("languagenameが指定されていません！");
        }

        // サーバーからARモデルデータを取得
        fetch(`/multiAR?languagename=${languagename}`)
            .then(response => response.json())
            .then(models => {
                models.forEach(model => {
                    // 3Dモデルの追加
                    const assetItem = document.createElement('a-asset-item');
                    assetItem.id = model.mdlid;
                    assetItem.setAttribute('src', `../Content/.glb/${model.mdlimage}`);
                    assetItem.onerror = () => console.error(`Failed to load GLB file: ${model.mdlimage}`);
                    document.querySelector('a-assets').appendChild(assetItem);

                    // 音声ファイルの追加
                    const audio = document.createElement('audio');
                    audio.id = model.mdlid;
                    audio.setAttribute('src', `../Content/${model.soundfile}`);
                    audio.preload = 'auto';
                    document.querySelector('a-assets').appendChild(audio);

                    // マーカーの設定
                    const marker = document.createElement('a-marker');
                    marker.id = model.mdlid;
                    marker.setAttribute('type', 'pattern');
                    marker.setAttribute('preset', 'custom');
                    marker.setAttribute('url', `../Content/.patt/${model.patt}`);
                    marker.setAttribute('raycaster', 'objects: .clickable');
                    marker.setAttribute('emitevents', 'true');
                    marker.setAttribute('cursor', 'fuse: false; rayOrigin: mouse;');

                    const entity = document.createElement('a-entity');
                    entity.setAttribute('scale', '1 1 1');
                    entity.setAttribute('animation-mixer', 'loop: repeat');
                    entity.setAttribute('gltf-model', `#${model.mdlid}`);
                    entity.classList.add('clickable');
                    entity.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 3600; easing: linear; loop: true');
                    entity.setAttribute('gesture-handler', '');
                    entity.setAttribute('visible', 'false');

                    marker.appendChild(entity);
                    document.querySelector('a-scene').appendChild(marker);
                });
            })
            .catch(error => {
                console.error('ARモデルの取得に失敗しました:', error);
            });
    </script>
</body>

</html>
